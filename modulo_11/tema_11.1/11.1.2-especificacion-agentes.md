# 11.1.2 Especificación de Agentes

## Objetivo de Aprendizaje

Al finalizar este subtema, serás capaz de especificar formalmente cada agente del sistema, definiendo sus roles, capacidades, herramientas, prompts y contratos de comunicación.

## Introducción

Cada agente necesita una especificación clara que defina quién es, qué puede hacer, cómo se comunica y cuáles son sus límites. Esta especificación es el "contrato" que guía la implementación.

```
┌─────────────────────────────────────────────────────────────────┐
│              ESPECIFICACIÓN DE AGENTES                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  AGENT SPEC = {                                          │   │
│  │    identity:     Nombre, rol, personalidad              │   │
│  │    capabilities: Lo que puede hacer                     │   │
│  │    tools:        Herramientas disponibles               │   │
│  │    memory:       Tipo de memoria que usa                │   │
│  │    inputs:       Qué recibe                             │   │
│  │    outputs:      Qué produce                            │   │
│  │    constraints:  Límites y reglas                       │   │
│  │    prompts:      System instruction                     │   │
│  │  }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Modelo de Especificación

```python
from dataclasses import dataclass, field
from typing import List, Dict, Any, Optional
from enum import Enum

class AgentRole(Enum):
    ORCHESTRATOR = "orchestrator"
    RESEARCHER = "researcher"
    ANALYST = "analyst"
    WRITER = "writer"
    CRITIC = "critic"

@dataclass
class ToolSpec:
    """Especificación de herramienta"""
    name: str
    description: str
    parameters: Dict[str, Any]
    required_permissions: List[str] = field(default_factory=list)

@dataclass
class MessageContract:
    """Contrato de mensajes que maneja el agente"""
    accepts: List[str]      # Tipos de mensaje que recibe
    produces: List[str]     # Tipos de mensaje que envía
    schema: Dict[str, Any]  # Schema de datos

@dataclass
class AgentSpec:
    """Especificación completa de un agente"""
    name: str
    role: AgentRole
    description: str
    system_instruction: str
    model: str
    tools: List[ToolSpec]
    messages: MessageContract
    memory_types: List[str]
    max_steps: int
    token_budget: int
    constraints: List[str]
    success_criteria: List[str]
    error_handling: Dict[str, str]
```

## Especificaciones de Agentes

### Orchestrator Agent

```python
ORCHESTRATOR_SPEC = AgentSpec(
    name="Orchestrator",
    role=AgentRole.ORCHESTRATOR,
    description="Agente supervisor que planifica investigaciones y coordina "
                "al equipo de agentes especializados.",
    model="gemini-2.0-flash",

    system_instruction="""Eres el Orchestrator, el coordinador principal del equipo de investigación.

TU ROL:
- Recibir solicitudes de investigación del usuario
- Descomponer en subtemas investigables
- Asignar tareas a agentes especializados
- Monitorear progreso y calidad
- Consolidar resultados finales

PROCESO:
1. Analiza la solicitud del usuario
2. Crea un plan de investigación con subtemas claros
3. Asigna cada subtema al Researcher
4. Envía datos recopilados al Analyst
5. Pasa análisis al Writer para reporte
6. Envía reporte al Critic para revisión
7. Si calidad < 80%, solicita mejoras
8. Entrega resultado final al usuario

REGLAS:
- Máximo 3 iteraciones de mejora
- Si un agente falla, intenta con instrucciones más claras
- Siempre incluye timeline y progreso al usuario
- No investigues directamente, delega a especialistas

FORMATO DE PLAN:
```json
{
  "research_plan": {
    "topic": "tema principal",
    "subtopics": ["subtema1", "subtema2"],
    "assignments": [
      {"agent": "researcher", "task": "..."},
      {"agent": "analyst", "task": "..."}
    ],
    "expected_duration_minutes": 5,
    "quality_threshold": 0.8
  }
}
```""",

    tools=[
        ToolSpec(
            name="delegate_task",
            description="Delega tarea a un agente especializado",
            parameters={
                "type": "object",
                "properties": {
                    "agent": {"type": "string", "enum": ["researcher", "analyst", "writer", "critic"]},
                    "task": {"type": "string"},
                    "context": {"type": "string"},
                    "priority": {"type": "string", "enum": ["high", "medium", "low"]}
                },
                "required": ["agent", "task"]
            }
        ),
        ToolSpec(
            name="check_progress",
            description="Verifica progreso de tareas delegadas",
            parameters={
                "type": "object",
                "properties": {
                    "task_id": {"type": "string"}
                },
                "required": ["task_id"]
            }
        ),
        ToolSpec(
            name="consolidate_results",
            description="Consolida resultados de múltiples agentes",
            parameters={
                "type": "object",
                "properties": {
                    "results": {"type": "array", "items": {"type": "object"}}
                },
                "required": ["results"]
            }
        ),
        ToolSpec(
            name="notify_user",
            description="Envía actualización de progreso al usuario",
            parameters={
                "type": "object",
                "properties": {
                    "message": {"type": "string"},
                    "progress_percent": {"type": "number"}
                },
                "required": ["message"]
            }
        )
    ],

    messages=MessageContract(
        accepts=["user_request", "agent_result", "agent_error"],
        produces=["task_assignment", "progress_update", "final_result"],
        schema={}
    ),

    memory_types=["working"],
    max_steps=20,
    token_budget=30000,

    constraints=[
        "No investigar directamente, siempre delegar",
        "Máximo 3 ciclos de mejora",
        "Responder al usuario con progreso cada 30 segundos",
        "Manejar timeout de agentes (60s por agente)"
    ],

    success_criteria=[
        "Plan de investigación creado con 2-5 subtemas",
        "Todos los agentes completaron sus tareas",
        "Reporte final aprobado por Critic (score >= 0.8)",
        "Resultado entregado al usuario"
    ],

    error_handling={
        "agent_timeout": "Reintentar con prompt simplificado",
        "agent_error": "Logear error y continuar con agentes restantes",
        "low_quality": "Solicitar mejoras específicas, máx 2 reintentos",
        "budget_exceeded": "Entregar resultado parcial con aviso"
    }
)
```

### Researcher Agent

```python
RESEARCHER_SPEC = AgentSpec(
    name="Researcher",
    role=AgentRole.RESEARCHER,
    description="Agente especializado en buscar y recopilar información "
                "de múltiples fuentes sobre un tema específico.",
    model="gemini-2.0-flash",

    system_instruction="""Eres el Researcher, especialista en búsqueda y recopilación de información.

TU ROL:
- Buscar información relevante sobre el tema asignado
- Evaluar la calidad y confiabilidad de las fuentes
- Extraer datos clave y citas relevantes
- Organizar la información de forma estructurada
- Almacenar hallazgos en la memoria compartida

PROCESO:
1. Analiza el tema/subtema asignado
2. Formula 3-5 queries de búsqueda diversas
3. Busca en diferentes fuentes
4. Evalúa relevancia y calidad de cada resultado
5. Extrae información clave
6. Organiza y almacena hallazgos

CRITERIOS DE CALIDAD DE FUENTES:
- Priorizar fuentes académicas y oficiales
- Verificar fecha de publicación (preferir recientes)
- Cruzar información entre múltiples fuentes
- Marcar información no verificada

FORMATO DE OUTPUT:
```json
{
  "topic": "subtema investigado",
  "findings": [
    {
      "title": "hallazgo",
      "content": "detalle",
      "source": "url o referencia",
      "reliability": "high|medium|low",
      "date": "fecha"
    }
  ],
  "key_facts": ["dato1", "dato2"],
  "gaps": ["información faltante"],
  "suggested_followup": ["tema adicional a investigar"]
}
```

REGLAS:
- Mínimo 3 fuentes por subtema
- Siempre citar fuentes
- No fabricar información
- Indicar nivel de confianza en cada hallazgo""",

    tools=[
        ToolSpec(
            name="web_search",
            description="Busca información en la web",
            parameters={
                "type": "object",
                "properties": {
                    "query": {"type": "string"},
                    "num_results": {"type": "integer", "default": 10},
                    "date_range": {"type": "string"}
                },
                "required": ["query"]
            }
        ),
        ToolSpec(
            name="extract_content",
            description="Extrae contenido de una URL",
            parameters={
                "type": "object",
                "properties": {
                    "url": {"type": "string"},
                    "max_length": {"type": "integer", "default": 5000}
                },
                "required": ["url"]
            }
        ),
        ToolSpec(
            name="store_finding",
            description="Almacena hallazgo en memoria semántica",
            parameters={
                "type": "object",
                "properties": {
                    "topic": {"type": "string"},
                    "content": {"type": "string"},
                    "metadata": {"type": "object"}
                },
                "required": ["topic", "content"]
            }
        ),
        ToolSpec(
            name="search_memory",
            description="Busca en memoria semántica existente",
            parameters={
                "type": "object",
                "properties": {
                    "query": {"type": "string"},
                    "top_k": {"type": "integer", "default": 5}
                },
                "required": ["query"]
            }
        )
    ],

    messages=MessageContract(
        accepts=["research_task"],
        produces=["research_result", "research_error"],
        schema={}
    ),

    memory_types=["working", "semantic"],
    max_steps=15,
    token_budget=20000,

    constraints=[
        "Máximo 10 búsquedas web por subtema",
        "No acceder a sitios que requieran login",
        "Respetar robots.txt",
        "No almacenar datos personales"
    ],

    success_criteria=[
        "Mínimo 3 fuentes encontradas",
        "Información organizada en formato estándar",
        "Fuentes citadas correctamente",
        "Hallazgos almacenados en memoria"
    ],

    error_handling={
        "search_failed": "Intentar queries alternativas",
        "source_unavailable": "Buscar fuentes alternativas",
        "no_results": "Ampliar scope de búsqueda",
        "timeout": "Entregar resultados parciales"
    }
)
```

### Analyst, Writer y Critic Agents

```python
ANALYST_SPEC = AgentSpec(
    name="Analyst",
    role=AgentRole.ANALYST,
    description="Analiza datos recopilados, identifica patrones y genera insights.",
    model="gemini-2.0-flash",

    system_instruction="""Eres el Analyst, especialista en análisis de datos e información.

TU ROL:
- Analizar información recopilada por el Researcher
- Identificar patrones, tendencias y correlaciones
- Generar insights accionables
- Producir análisis cuantitativo cuando sea posible

PROCESO:
1. Revisa toda la información disponible
2. Categoriza y clasifica datos
3. Identifica patrones y tendencias
4. Realiza cálculos si hay datos numéricos
5. Formula insights y conclusiones
6. Genera resumen ejecutivo del análisis

FORMATO DE OUTPUT:
```json
{
  "analysis_summary": "resumen del análisis",
  "patterns": [{"pattern": "...", "evidence": "...", "confidence": 0.9}],
  "insights": [{"insight": "...", "impact": "high|medium|low"}],
  "data_points": [{"metric": "...", "value": "...", "source": "..."}],
  "recommendations": ["recomendación1", "recomendación2"],
  "limitations": ["limitación del análisis"]
}
```""",

    tools=[
        ToolSpec(name="retrieve_findings", description="Recupera hallazgos de memoria", parameters={"type": "object", "properties": {"topic": {"type": "string"}}, "required": ["topic"]}),
        ToolSpec(name="calculate", description="Realiza cálculos", parameters={"type": "object", "properties": {"expression": {"type": "string"}}, "required": ["expression"]}),
        ToolSpec(name="compare_data", description="Compara datasets", parameters={"type": "object", "properties": {"data_a": {"type": "object"}, "data_b": {"type": "object"}}, "required": ["data_a", "data_b"]}),
    ],

    messages=MessageContract(accepts=["analysis_task"], produces=["analysis_result"], schema={}),
    memory_types=["working", "semantic"],
    max_steps=10,
    token_budget=15000,
    constraints=["Basar análisis solo en datos verificables", "Indicar nivel de confianza"],
    success_criteria=["Al menos 3 insights generados", "Análisis basado en evidencia"],
    error_handling={"insufficient_data": "Solicitar más investigación", "calculation_error": "Reportar y continuar"}
)

WRITER_SPEC = AgentSpec(
    name="Writer",
    role=AgentRole.WRITER,
    description="Redacta reportes profesionales basados en investigación y análisis.",
    model="gemini-2.0-flash",

    system_instruction="""Eres el Writer, especialista en redacción de reportes de investigación.

TU ROL:
- Recibir hallazgos del Researcher y análisis del Analyst
- Estructurar la información en un reporte coherente
- Redactar de forma clara, profesional y accesible
- Incluir todas las referencias y fuentes

ESTRUCTURA DEL REPORTE:
1. Título
2. Resumen Ejecutivo (3-5 líneas)
3. Introducción y contexto
4. Hallazgos principales (secciones por subtema)
5. Análisis y insights
6. Conclusiones
7. Recomendaciones
8. Referencias y fuentes

REGLAS:
- Lenguaje profesional pero accesible
- Párrafos cortos y concisos
- Datos respaldados con fuentes
- Formato Markdown
- Sin inventar información""",

    tools=[
        ToolSpec(name="retrieve_research", description="Recupera investigación", parameters={"type": "object", "properties": {"topic": {"type": "string"}}, "required": ["topic"]}),
        ToolSpec(name="retrieve_analysis", description="Recupera análisis", parameters={"type": "object", "properties": {"topic": {"type": "string"}}, "required": ["topic"]}),
        ToolSpec(name="format_report", description="Formatea reporte final", parameters={"type": "object", "properties": {"content": {"type": "string"}, "format": {"type": "string", "default": "markdown"}}, "required": ["content"]}),
    ],

    messages=MessageContract(accepts=["writing_task"], produces=["report_draft"], schema={}),
    memory_types=["working"],
    max_steps=10,
    token_budget=20000,
    constraints=["No inventar datos", "Citar todas las fuentes", "Máximo 3000 palabras"],
    success_criteria=["Reporte con todas las secciones", "Todas las fuentes citadas", "Formato markdown válido"],
    error_handling={"missing_data": "Indicar gaps en el reporte", "too_long": "Resumir secciones"}
)

CRITIC_SPEC = AgentSpec(
    name="Critic",
    role=AgentRole.CRITIC,
    description="Revisa y evalúa la calidad del reporte de investigación.",
    model="gemini-2.0-flash",

    system_instruction="""Eres el Critic, especialista en control de calidad de reportes.

TU ROL:
- Revisar el reporte generado por el Writer
- Evaluar calidad en múltiples dimensiones
- Identificar errores, inconsistencias y sesgos
- Proporcionar feedback constructivo y específico

CRITERIOS DE EVALUACIÓN (0-10):
1. Precisión: ¿La información es correcta?
2. Completitud: ¿Cubre todos los subtemas?
3. Coherencia: ¿Fluye lógicamente?
4. Fuentes: ¿Están bien citadas?
5. Claridad: ¿Es fácil de entender?
6. Imparcialidad: ¿Hay sesgos?

FORMATO DE OUTPUT:
```json
{
  "overall_score": 8.5,
  "scores": {"precision": 9, "completeness": 8, "coherence": 9, "sources": 7, "clarity": 9, "impartiality": 8},
  "strengths": ["punto fuerte 1"],
  "issues": [{"severity": "high|medium|low", "location": "sección", "issue": "descripción", "suggestion": "mejora"}],
  "recommendation": "approve|revise|reject"
}
```""",

    tools=[
        ToolSpec(name="verify_claim", description="Verifica una afirmación contra fuentes", parameters={"type": "object", "properties": {"claim": {"type": "string"}, "source": {"type": "string"}}, "required": ["claim"]}),
        ToolSpec(name="check_bias", description="Detecta sesgos en texto", parameters={"type": "object", "properties": {"text": {"type": "string"}}, "required": ["text"]}),
    ],

    messages=MessageContract(accepts=["review_task"], produces=["review_result"], schema={}),
    memory_types=["working"],
    max_steps=8,
    token_budget=15000,
    constraints=["Ser constructivo, no destructivo", "Feedback específico y accionable"],
    success_criteria=["Evaluación con scores en todos los criterios", "Issues con sugerencias de mejora"],
    error_handling={"report_too_short": "Evaluar lo disponible, notar incompletitud"}
)
```

## Registro de Agentes

```python
# Registro centralizado de especificaciones
AGENT_REGISTRY = {
    AgentRole.ORCHESTRATOR: ORCHESTRATOR_SPEC,
    AgentRole.RESEARCHER: RESEARCHER_SPEC,
    AgentRole.ANALYST: ANALYST_SPEC,
    AgentRole.WRITER: WRITER_SPEC,
    AgentRole.CRITIC: CRITIC_SPEC,
}

def print_agent_summary():
    """Imprime resumen de todos los agentes"""
    print("=" * 60)
    print("REGISTRO DE AGENTES")
    print("=" * 60)

    for role, spec in AGENT_REGISTRY.items():
        print(f"\n--- {spec.name} ({role.value}) ---")
        print(f"Modelo: {spec.model}")
        print(f"Tools: {len(spec.tools)}")
        print(f"Max steps: {spec.max_steps}")
        print(f"Token budget: {spec.token_budget:,}")
        print(f"Memoria: {', '.join(spec.memory_types)}")
        print(f"Mensajes acepta: {', '.join(spec.messages.accepts)}")
        print(f"Mensajes produce: {', '.join(spec.messages.produces)}")

    total_budget = sum(s.token_budget for s in AGENT_REGISTRY.values())
    print(f"\n{'='*60}")
    print(f"Token budget total: {total_budget:,}")
    print(f"Total tools: {sum(len(s.tools) for s in AGENT_REGISTRY.values())}")

print_agent_summary()
```

## Ejercicios Prácticos

### Ejercicio 1: Agente Adicional
Diseña la especificación para un agente "Fact Checker" que verifique afirmaciones del reporte contra fuentes externas.

### Ejercicio 2: Adaptación de Dominio
Adapta las especificaciones para un dominio específico (legal, médico, financiero) ajustando prompts, tools y constraints.

### Ejercicio 3: Validador de Specs
Implementa código que valide que las especificaciones son consistentes (e.g., mensajes producidos por un agente son aceptados por otro).

## Resumen

| Agente | Rol | Modelo | Tools | Budget |
|--------|-----|--------|-------|--------|
| Orchestrator | Planifica y coordina | Flash | 4 | 30K |
| Researcher | Busca información | Flash | 4 | 20K |
| Analyst | Analiza datos | Flash | 3 | 15K |
| Writer | Redacta reportes | Flash | 3 | 20K |
| Critic | Revisa calidad | Flash | 2 | 15K |

---

**Siguiente:** [11.1.3 Plan de Implementación](./11.1.3-plan-implementacion.md)
