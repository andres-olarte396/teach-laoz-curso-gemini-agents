# 7.3.2 CrewAI para Equipos de Agentes

## Objetivo de Aprendizaje

Implementar equipos de agentes colaborativos usando CrewAI, definiendo roles especializados, tareas estructuradas y flujos de trabajo coordinados, con Google Gemini como modelo de razonamiento.

## Introducci√≥n

CrewAI es un framework que facilita la creaci√≥n de equipos de agentes con roles definidos que colaboran para completar tareas complejas. Su enfoque en roles, metas y backstories permite crear agentes m√°s especializados y efectivos.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      CREWAI ARCHITECTURE                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ   ‚îÇ                        CREW                              ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ                    AGENTS                           ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  ‚îÇ  Agent 1  ‚îÇ ‚îÇ  Agent 2  ‚îÇ ‚îÇ  Agent 3  ‚îÇ         ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  ‚îÇ ‚Ä¢ Role    ‚îÇ ‚îÇ ‚Ä¢ Role    ‚îÇ ‚îÇ ‚Ä¢ Role    ‚îÇ         ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  ‚îÇ ‚Ä¢ Goal    ‚îÇ ‚îÇ ‚Ä¢ Goal    ‚îÇ ‚îÇ ‚Ä¢ Goal    ‚îÇ         ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  ‚îÇ ‚Ä¢ Backstory‚îÇ ‚îÇ ‚Ä¢ Backstory‚îÇ ‚îÇ ‚Ä¢ Backstory‚îÇ       ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  ‚îÇ ‚Ä¢ Tools   ‚îÇ ‚îÇ ‚Ä¢ Tools   ‚îÇ ‚îÇ ‚Ä¢ Tools   ‚îÇ         ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ                     TASKS                           ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  Task 1 ‚îÄ‚îÄ‚îÄ> Task 2 ‚îÄ‚îÄ‚îÄ> Task 3 ‚îÄ‚îÄ‚îÄ> Output        ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ  (Agent 1)   (Agent 2)   (Agent 3)                 ‚îÇ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ  ‚îÇ
‚îÇ   ‚îÇ                                                         ‚îÇ  ‚îÇ
‚îÇ   ‚îÇ  Process: sequential | hierarchical | consensual        ‚îÇ  ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Configuraci√≥n e Instalaci√≥n

```python
"""
Configuraci√≥n de CrewAI con Google Gemini.
"""
# pip install crewai crewai-tools langchain-google-genai

from crewai import Agent, Task, Crew, Process
from langchain_google_genai import ChatGoogleGenerativeAI
import os

# Configurar API key
os.environ["GOOGLE_API_KEY"] = "tu-api-key"

# Crear LLM de Gemini para CrewAI
def get_gemini_llm(
    model: str = "gemini-1.5-flash",
    temperature: float = 0.7
) -> ChatGoogleGenerativeAI:
    """Obtiene instancia de Gemini para CrewAI."""
    return ChatGoogleGenerativeAI(
        model=model,
        temperature=temperature,
        convert_system_message_to_human=True
    )
```

## Creaci√≥n de Agentes Especializados

```python
"""
Definici√≥n de agentes con roles espec√≠ficos.
"""
from crewai import Agent
from langchain_google_genai import ChatGoogleGenerativeAI
from crewai_tools import SerperDevTool, WebsiteSearchTool
from typing import List, Optional
import os


class GeminiAgentFactory:
    """F√°brica para crear agentes con Gemini."""

    def __init__(self, api_key: str = None):
        self.api_key = api_key or os.getenv("GOOGLE_API_KEY")
        self.llm = ChatGoogleGenerativeAI(
            model="gemini-1.5-flash",
            google_api_key=self.api_key,
            temperature=0.7
        )

    def create_researcher(
        self,
        specialty: str = "general",
        tools: List = None
    ) -> Agent:
        """Crea un agente investigador."""
        return Agent(
            role=f"Investigador Senior de {specialty}",
            goal=f"Investigar exhaustivamente sobre {specialty} y proporcionar informaci√≥n precisa y actualizada",
            backstory=f"""Eres un investigador experimentado con m√°s de 15 a√±os
            de experiencia en {specialty}. Has publicado numerosos art√≠culos
            y eres reconocido por tu capacidad de encontrar informaci√≥n
            relevante y verificar fuentes. Tu metodolog√≠a rigurosa te ha
            ganado el respeto de la comunidad acad√©mica y profesional.""",
            verbose=True,
            allow_delegation=True,
            llm=self.llm,
            tools=tools or []
        )

    def create_analyst(
        self,
        domain: str = "datos",
        tools: List = None
    ) -> Agent:
        """Crea un agente analista."""
        return Agent(
            role=f"Analista Experto en {domain}",
            goal=f"Analizar informaci√≥n sobre {domain} y extraer insights accionables",
            backstory=f"""Eres un analista de {domain} con experiencia en
            m√∫ltiples industrias. Tu habilidad para encontrar patrones
            ocultos y transformar datos complejos en insights claros te
            ha convertido en un recurso invaluable. Combinas pensamiento
            cr√≠tico con creatividad para resolver problemas complejos.""",
            verbose=True,
            allow_delegation=False,
            llm=self.llm,
            tools=tools or []
        )

    def create_writer(
        self,
        style: str = "profesional",
        tools: List = None
    ) -> Agent:
        """Crea un agente escritor."""
        return Agent(
            role=f"Escritor {style.capitalize()} Senior",
            goal=f"Crear contenido {style} de alta calidad que comunique efectivamente",
            backstory=f"""Eres un escritor {style} con talento para
            transformar ideas complejas en contenido claro y atractivo.
            Has trabajado con marcas l√≠deres y tu trabajo ha sido
            reconocido por su claridad, precisi√≥n y capacidad de
            conectar con audiencias diversas. Tu estilo se adapta
            perfectamente al contexto y la audiencia objetivo.""",
            verbose=True,
            allow_delegation=False,
            llm=self.llm,
            tools=tools or []
        )

    def create_reviewer(
        self,
        focus: str = "calidad",
        tools: List = None
    ) -> Agent:
        """Crea un agente revisor."""
        return Agent(
            role=f"Revisor de {focus.capitalize()}",
            goal=f"Asegurar la m√°s alta {focus} en todos los entregables",
            backstory=f"""Eres un revisor meticuloso con un ojo
            excepcional para el detalle. Tu experiencia abarca
            m√∫ltiples dominios y has desarrollado frameworks de
            evaluaci√≥n que garantizan {focus} consistente.
            Tu feedback es constructivo y orientado a la mejora.""",
            verbose=True,
            allow_delegation=False,
            llm=self.llm,
            tools=tools or []
        )

    def create_project_manager(
        self,
        tools: List = None
    ) -> Agent:
        """Crea un agente gestor de proyecto."""
        return Agent(
            role="Gerente de Proyecto Senior",
            goal="Coordinar el equipo y asegurar la entrega exitosa del proyecto",
            backstory="""Eres un gerente de proyecto certificado PMP con
            amplia experiencia liderando equipos multidisciplinarios.
            Tu habilidad para mantener proyectos en tiempo y alcance,
            mientras mantienes alta moral del equipo, te ha ganado
            m√∫ltiples reconocimientos. Eres experto en resolver
            conflictos y optimizar procesos.""",
            verbose=True,
            allow_delegation=True,
            llm=self.llm,
            tools=tools or []
        )

    def create_technical_expert(
        self,
        technology: str,
        tools: List = None
    ) -> Agent:
        """Crea un agente experto t√©cnico."""
        return Agent(
            role=f"Experto Senior en {technology}",
            goal=f"Proporcionar soluciones t√©cnicas √≥ptimas en {technology}",
            backstory=f"""Eres un experto en {technology} con m√°s de
            10 a√±os de experiencia pr√°ctica. Has arquitectado sistemas
            a escala empresarial y contribuido a proyectos open source.
            Tu conocimiento profundo te permite encontrar soluciones
            elegantes a problemas complejos y mentorear a otros.""",
            verbose=True,
            allow_delegation=False,
            llm=self.llm,
            tools=tools or []
        )


# Ejemplo de uso
if __name__ == "__main__":
    factory = GeminiAgentFactory()

    researcher = factory.create_researcher("Inteligencia Artificial")
    analyst = factory.create_analyst("mercado tecnol√≥gico")
    writer = factory.create_writer("t√©cnico")

    print(f"Agente creado: {researcher.role}")
    print(f"Meta: {researcher.goal}")
```

## Definici√≥n de Tareas

```python
"""
Creaci√≥n de tareas estructuradas para el equipo.
"""
from crewai import Task, Agent
from typing import List, Optional, Any


class TaskBuilder:
    """Constructor de tareas para CrewAI."""

    @staticmethod
    def create_research_task(
        topic: str,
        agent: Agent,
        context: List[Task] = None,
        expected_output: str = None
    ) -> Task:
        """Crea una tarea de investigaci√≥n."""
        return Task(
            description=f"""Investigar exhaustivamente sobre: {topic}

            Tu investigaci√≥n debe incluir:
            1. Contexto hist√≥rico y evoluci√≥n
            2. Estado actual del tema
            3. Principales actores o stakeholders
            4. Tendencias emergentes
            5. Desaf√≠os y oportunidades
            6. Fuentes confiables consultadas

            Aseg√∫rate de verificar la informaci√≥n y citar fuentes cuando sea posible.""",
            expected_output=expected_output or f"""Un informe de investigaci√≥n completo sobre {topic}
            con secciones claras, datos verificados y fuentes citadas.
            El informe debe ser objetivo y basado en evidencia.""",
            agent=agent,
            context=context
        )

    @staticmethod
    def create_analysis_task(
        data_description: str,
        agent: Agent,
        context: List[Task] = None,
        expected_output: str = None
    ) -> Task:
        """Crea una tarea de an√°lisis."""
        return Task(
            description=f"""Analizar los siguientes datos/informaci√≥n: {data_description}

            Tu an√°lisis debe incluir:
            1. Resumen ejecutivo de hallazgos
            2. Patrones y tendencias identificadas
            3. Correlaciones significativas
            4. Insights accionables
            5. Recomendaciones basadas en el an√°lisis
            6. Limitaciones del an√°lisis

            Presenta los datos de forma visual cuando sea apropiado.""",
            expected_output=expected_output or """Un an√°lisis detallado con insights claros,
            visualizaciones de datos cuando corresponda, y recomendaciones
            accionables basadas en evidencia.""",
            agent=agent,
            context=context
        )

    @staticmethod
    def create_writing_task(
        content_type: str,
        topic: str,
        agent: Agent,
        context: List[Task] = None,
        target_audience: str = "profesionales",
        expected_output: str = None
    ) -> Task:
        """Crea una tarea de escritura."""
        return Task(
            description=f"""Crear un {content_type} sobre: {topic}

            Audiencia objetivo: {target_audience}

            El contenido debe:
            1. Captar la atenci√≥n desde el inicio
            2. Ser claro y f√°cil de seguir
            3. Incluir ejemplos relevantes
            4. Mantener un tono apropiado para la audiencia
            5. Tener una estructura l√≥gica
            6. Incluir una conclusi√≥n memorable

            Basarte en la investigaci√≥n y an√°lisis previos si est√°n disponibles.""",
            expected_output=expected_output or f"""Un {content_type} bien estructurado,
            atractivo y profesional sobre {topic}, optimizado para {target_audience}.""",
            agent=agent,
            context=context
        )

    @staticmethod
    def create_review_task(
        content_to_review: str,
        agent: Agent,
        context: List[Task] = None,
        criteria: List[str] = None
    ) -> Task:
        """Crea una tarea de revisi√≥n."""
        criteria_text = "\n".join([f"- {c}" for c in (criteria or [
            "Precisi√≥n y exactitud del contenido",
            "Claridad y legibilidad",
            "Estructura y organizaci√≥n",
            "Gram√°tica y estilo",
            "Relevancia para la audiencia objetivo"
        ])])

        return Task(
            description=f"""Revisar el siguiente contenido: {content_to_review}

            Criterios de evaluaci√≥n:
            {criteria_text}

            Tu revisi√≥n debe:
            1. Identificar fortalezas del contenido
            2. Se√±alar √°reas de mejora espec√≠ficas
            3. Proporcionar sugerencias concretas
            4. Dar una puntuaci√≥n general (1-10)
            5. Recomendar si est√° listo o necesita revisi√≥n""",
            expected_output="""Una revisi√≥n detallada con feedback constructivo,
            sugerencias de mejora espec√≠ficas y una evaluaci√≥n clara
            de la calidad del contenido.""",
            agent=agent,
            context=context
        )

    @staticmethod
    def create_technical_task(
        requirement: str,
        agent: Agent,
        context: List[Task] = None,
        constraints: List[str] = None
    ) -> Task:
        """Crea una tarea t√©cnica."""
        constraints_text = ""
        if constraints:
            constraints_text = "\n\nRestricciones:\n" + "\n".join([f"- {c}" for c in constraints])

        return Task(
            description=f"""Implementar soluci√≥n t√©cnica para: {requirement}
            {constraints_text}

            Tu soluci√≥n debe incluir:
            1. Dise√±o de la arquitectura/soluci√≥n
            2. C√≥digo funcional (si aplica)
            3. Documentaci√≥n t√©cnica
            4. Consideraciones de seguridad
            5. Plan de testing
            6. Instrucciones de implementaci√≥n""",
            expected_output="""Una soluci√≥n t√©cnica completa con c√≥digo funcional
            (si aplica), documentaci√≥n clara y gu√≠as de implementaci√≥n.""",
            agent=agent,
            context=context
        )


# Ejemplo de uso
if __name__ == "__main__":
    from crewai import Agent
    from langchain_google_genai import ChatGoogleGenerativeAI

    llm = ChatGoogleGenerativeAI(model="gemini-1.5-flash")

    researcher = Agent(
        role="Investigador",
        goal="Investigar temas a profundidad",
        backstory="Investigador experto",
        llm=llm
    )

    task = TaskBuilder.create_research_task(
        topic="Tendencias en IA Generativa 2024",
        agent=researcher
    )

    print(f"Tarea creada: {task.description[:100]}...")
```

## Creaci√≥n de Crews

```python
"""
Configuraci√≥n de equipos (Crews) de agentes.
"""
from crewai import Crew, Process, Agent, Task
from langchain_google_genai import ChatGoogleGenerativeAI
from typing import List, Dict, Any
import os


class CrewBuilder:
    """Constructor de Crews para diferentes casos de uso."""

    def __init__(self, api_key: str = None):
        self.api_key = api_key or os.getenv("GOOGLE_API_KEY")
        self.llm = ChatGoogleGenerativeAI(
            model="gemini-1.5-flash",
            google_api_key=self.api_key,
            temperature=0.7
        )

    def build_content_creation_crew(
        self,
        topic: str,
        content_type: str = "art√≠culo",
        target_audience: str = "profesionales"
    ) -> Crew:
        """Crea un crew para creaci√≥n de contenido."""
        # Crear agentes
        researcher = Agent(
            role="Investigador de Contenido",
            goal="Investigar exhaustivamente para crear contenido preciso",
            backstory="Investigador experto en encontrar informaci√≥n relevante",
            llm=self.llm,
            verbose=True
        )

        writer = Agent(
            role="Escritor de Contenido",
            goal="Crear contenido atractivo y bien estructurado",
            backstory="Escritor profesional con experiencia en m√∫ltiples formatos",
            llm=self.llm,
            verbose=True
        )

        editor = Agent(
            role="Editor Senior",
            goal="Asegurar la calidad y coherencia del contenido",
            backstory="Editor con ojo cr√≠tico para el detalle y la calidad",
            llm=self.llm,
            verbose=True
        )

        # Crear tareas
        research_task = Task(
            description=f"Investigar sobre: {topic}. Recopilar informaci√≥n relevante, estad√≠sticas y ejemplos.",
            expected_output="Informe de investigaci√≥n con datos y fuentes",
            agent=researcher
        )

        writing_task = Task(
            description=f"Crear un {content_type} sobre {topic} para {target_audience}",
            expected_output=f"Un {content_type} completo y bien estructurado",
            agent=writer,
            context=[research_task]
        )

        editing_task = Task(
            description="Revisar y mejorar el contenido creado",
            expected_output="Contenido final pulido y listo para publicar",
            agent=editor,
            context=[writing_task]
        )

        # Crear crew
        return Crew(
            agents=[researcher, writer, editor],
            tasks=[research_task, writing_task, editing_task],
            process=Process.sequential,
            verbose=True
        )

    def build_analysis_crew(
        self,
        analysis_topic: str,
        data_sources: List[str] = None
    ) -> Crew:
        """Crea un crew para an√°lisis."""
        data_collector = Agent(
            role="Recolector de Datos",
            goal="Recopilar datos relevantes de m√∫ltiples fuentes",
            backstory="Experto en data gathering y web scraping",
            llm=self.llm,
            verbose=True
        )

        analyst = Agent(
            role="Analista de Datos Senior",
            goal="Analizar datos y extraer insights valiosos",
            backstory="Analista con experiencia en m√∫ltiples industrias",
            llm=self.llm,
            verbose=True
        )

        strategist = Agent(
            role="Estratega de Negocios",
            goal="Convertir insights en recomendaciones estrat√©gicas",
            backstory="Consultor estrat√©gico con track record probado",
            llm=self.llm,
            verbose=True
        )

        sources_text = ", ".join(data_sources) if data_sources else "fuentes disponibles"

        collect_task = Task(
            description=f"Recopilar datos sobre {analysis_topic} de {sources_text}",
            expected_output="Dataset compilado con datos relevantes",
            agent=data_collector
        )

        analyze_task = Task(
            description=f"Analizar datos sobre {analysis_topic}, identificar patrones y tendencias",
            expected_output="An√°lisis detallado con visualizaciones",
            agent=analyst,
            context=[collect_task]
        )

        strategize_task = Task(
            description="Desarrollar recomendaciones estrat√©gicas basadas en el an√°lisis",
            expected_output="Plan estrat√©gico con recomendaciones accionables",
            agent=strategist,
            context=[analyze_task]
        )

        return Crew(
            agents=[data_collector, analyst, strategist],
            tasks=[collect_task, analyze_task, strategize_task],
            process=Process.sequential,
            verbose=True
        )

    def build_development_crew(
        self,
        project_description: str,
        tech_stack: List[str] = None
    ) -> Crew:
        """Crea un crew para desarrollo de software."""
        tech_text = ", ".join(tech_stack) if tech_stack else "tecnolog√≠as apropiadas"

        architect = Agent(
            role="Arquitecto de Software",
            goal="Dise√±ar arquitectura robusta y escalable",
            backstory="Arquitecto senior con experiencia en sistemas distribuidos",
            llm=self.llm,
            verbose=True
        )

        developer = Agent(
            role="Desarrollador Senior",
            goal="Implementar c√≥digo limpio y funcional",
            backstory="Desarrollador full-stack con expertise en m√∫ltiples lenguajes",
            llm=self.llm,
            verbose=True
        )

        tester = Agent(
            role="QA Engineer",
            goal="Asegurar la calidad del software mediante testing exhaustivo",
            backstory="Experto en testing automatizado y QA",
            llm=self.llm,
            verbose=True
        )

        documenter = Agent(
            role="Technical Writer",
            goal="Crear documentaci√≥n clara y completa",
            backstory="Escritor t√©cnico con habilidad para explicar conceptos complejos",
            llm=self.llm,
            verbose=True
        )

        design_task = Task(
            description=f"Dise√±ar arquitectura para: {project_description}. Usar {tech_text}",
            expected_output="Documento de arquitectura con diagramas",
            agent=architect
        )

        develop_task = Task(
            description="Implementar la soluci√≥n seg√∫n la arquitectura dise√±ada",
            expected_output="C√≥digo funcional con estructura limpia",
            agent=developer,
            context=[design_task]
        )

        test_task = Task(
            description="Crear y ejecutar plan de testing",
            expected_output="Reporte de testing con cobertura",
            agent=tester,
            context=[develop_task]
        )

        document_task = Task(
            description="Documentar la soluci√≥n desarrollada",
            expected_output="Documentaci√≥n t√©cnica completa",
            agent=documenter,
            context=[develop_task, test_task]
        )

        return Crew(
            agents=[architect, developer, tester, documenter],
            tasks=[design_task, develop_task, test_task, document_task],
            process=Process.sequential,
            verbose=True
        )

    def build_hierarchical_crew(
        self,
        project_goal: str
    ) -> Crew:
        """Crea un crew con proceso jer√°rquico."""
        manager = Agent(
            role="Project Manager",
            goal="Coordinar el equipo y asegurar entrega exitosa",
            backstory="PM experimentado con certificaci√≥n PMP",
            llm=self.llm,
            verbose=True,
            allow_delegation=True
        )

        specialist_1 = Agent(
            role="Especialista en Investigaci√≥n",
            goal="Proporcionar informaci√≥n precisa y relevante",
            backstory="Investigador con acceso a m√∫ltiples fuentes",
            llm=self.llm,
            verbose=True
        )

        specialist_2 = Agent(
            role="Especialista en An√°lisis",
            goal="Analizar informaci√≥n y generar insights",
            backstory="Analista con experiencia en data science",
            llm=self.llm,
            verbose=True
        )

        specialist_3 = Agent(
            role="Especialista en Comunicaci√≥n",
            goal="Crear entregables de alta calidad",
            backstory="Comunicador experto en m√∫ltiples formatos",
            llm=self.llm,
            verbose=True
        )

        main_task = Task(
            description=f"""Completar el siguiente proyecto: {project_goal}

            Como Project Manager, debes:
            1. Descomponer el proyecto en subtareas
            2. Asignar tareas a los especialistas apropiados
            3. Coordinar la ejecuci√≥n
            4. Integrar los resultados
            5. Entregar el producto final""",
            expected_output="Proyecto completado con todos los entregables",
            agent=manager
        )

        return Crew(
            agents=[manager, specialist_1, specialist_2, specialist_3],
            tasks=[main_task],
            process=Process.hierarchical,
            manager_llm=self.llm,
            verbose=True
        )


# Ejemplo de uso
if __name__ == "__main__":
    builder = CrewBuilder()

    # Crear crew de contenido
    content_crew = builder.build_content_creation_crew(
        topic="El futuro de la IA en la educaci√≥n",
        content_type="art√≠culo de blog",
        target_audience="educadores"
    )

    # Ejecutar
    result = content_crew.kickoff()
    print(f"\n=== Resultado ===\n{result}")
```

## Crew con Herramientas Personalizadas

```python
"""
Integraci√≥n de herramientas personalizadas en CrewAI.
"""
from crewai import Agent, Task, Crew, Process
from crewai_tools import tool, BaseTool
from langchain_google_genai import ChatGoogleGenerativeAI
from typing import Any, Type
from pydantic import BaseModel, Field
import google.generativeai as genai
import os


# Herramienta personalizada usando decorador
@tool("Gemini Vision Analyzer")
def analyze_image_with_gemini(image_url: str, analysis_prompt: str) -> str:
    """Analiza una imagen usando Gemini Vision."""
    try:
        # Configurar Gemini
        genai.configure(api_key=os.getenv("GOOGLE_API_KEY"))
        model = genai.GenerativeModel("gemini-1.5-flash")

        # En producci√≥n, cargar imagen real
        response = model.generate_content([
            f"Analiza esta imagen seg√∫n: {analysis_prompt}",
            f"URL de imagen: {image_url}"
        ])

        return response.text
    except Exception as e:
        return f"Error analizando imagen: {str(e)}"


@tool("Gemini Code Generator")
def generate_code_with_gemini(requirement: str, language: str = "python") -> str:
    """Genera c√≥digo usando Gemini."""
    try:
        genai.configure(api_key=os.getenv("GOOGLE_API_KEY"))
        model = genai.GenerativeModel("gemini-1.5-flash")

        prompt = f"""Genera c√≥digo {language} para: {requirement}

        El c√≥digo debe ser:
        - Funcional y probado
        - Bien documentado
        - Siguiendo mejores pr√°cticas

        Proporciona solo el c√≥digo sin explicaci√≥n adicional."""

        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"Error generando c√≥digo: {str(e)}"


# Herramienta usando clase
class GeminiSearchToolInput(BaseModel):
    """Input schema para herramienta de b√∫squeda."""
    query: str = Field(..., description="Query de b√∫squeda")
    max_results: int = Field(default=5, description="N√∫mero m√°ximo de resultados")


class GeminiSearchTool(BaseTool):
    """Herramienta de b√∫squeda potenciada por Gemini."""
    name: str = "Gemini Search"
    description: str = "Busca informaci√≥n y la analiza con Gemini"
    args_schema: Type[BaseModel] = GeminiSearchToolInput

    def _run(self, query: str, max_results: int = 5) -> str:
        """Ejecuta la b√∫squeda."""
        try:
            genai.configure(api_key=os.getenv("GOOGLE_API_KEY"))
            model = genai.GenerativeModel("gemini-1.5-flash")

            prompt = f"""Act√∫a como un motor de b√∫squeda inteligente.
            Busca informaci√≥n sobre: {query}

            Proporciona los {max_results} resultados m√°s relevantes con:
            - T√≠tulo
            - Resumen
            - Relevancia

            Formatea como lista."""

            response = model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"Error en b√∫squeda: {str(e)}"


class GeminiSummarizer(BaseTool):
    """Herramienta de resumen con Gemini."""
    name: str = "Gemini Summarizer"
    description: str = "Resume textos largos de forma concisa"

    def _run(self, text: str, max_length: int = 200) -> str:
        """Resume el texto."""
        try:
            genai.configure(api_key=os.getenv("GOOGLE_API_KEY"))
            model = genai.GenerativeModel("gemini-1.5-flash")

            prompt = f"""Resume el siguiente texto en m√°ximo {max_length} palabras:

            {text}

            Resumen:"""

            response = model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"Error resumiendo: {str(e)}"


def build_crew_with_tools():
    """Construye crew con herramientas personalizadas."""
    llm = ChatGoogleGenerativeAI(model="gemini-1.5-flash")

    # Instanciar herramientas
    search_tool = GeminiSearchTool()
    summarizer = GeminiSummarizer()

    # Agente con herramientas
    researcher = Agent(
        role="Investigador con Herramientas",
        goal="Investigar usando herramientas especializadas",
        backstory="Investigador experto en uso de herramientas digitales",
        llm=llm,
        tools=[search_tool, analyze_image_with_gemini],
        verbose=True
    )

    analyst = Agent(
        role="Analista con Resumen",
        goal="Analizar y resumir informaci√≥n",
        backstory="Analista experto en s√≠ntesis de informaci√≥n",
        llm=llm,
        tools=[summarizer],
        verbose=True
    )

    developer = Agent(
        role="Desarrollador",
        goal="Implementar soluciones de c√≥digo",
        backstory="Desarrollador senior",
        llm=llm,
        tools=[generate_code_with_gemini],
        verbose=True
    )

    # Tareas
    research_task = Task(
        description="Investigar sobre machine learning en producci√≥n",
        expected_output="Informe de investigaci√≥n",
        agent=researcher
    )

    analysis_task = Task(
        description="Analizar y resumir los hallazgos de investigaci√≥n",
        expected_output="Resumen ejecutivo",
        agent=analyst,
        context=[research_task]
    )

    dev_task = Task(
        description="Crear c√≥digo de ejemplo para ML en producci√≥n",
        expected_output="C√≥digo Python funcional",
        agent=developer,
        context=[analysis_task]
    )

    return Crew(
        agents=[researcher, analyst, developer],
        tasks=[research_task, analysis_task, dev_task],
        process=Process.sequential,
        verbose=True
    )


# Ejemplo de uso
if __name__ == "__main__":
    crew = build_crew_with_tools()
    result = crew.kickoff()
    print(f"\n=== Resultado ===\n{result}")
```

## Crew con Callbacks y Monitoreo

```python
"""
Implementaci√≥n de callbacks para monitoreo de Crews.
"""
from crewai import Agent, Task, Crew, Process
from crewai.utilities import Logger
from langchain_google_genai import ChatGoogleGenerativeAI
from typing import Dict, Any, List, Callable
from datetime import datetime
import json


class CrewMonitor:
    """Monitor para tracking de ejecuci√≥n del Crew."""

    def __init__(self):
        self.events: List[Dict[str, Any]] = []
        self.start_time: datetime = None
        self.task_times: Dict[str, float] = {}

    def on_crew_start(self, crew_info: Dict[str, Any]):
        """Callback al iniciar crew."""
        self.start_time = datetime.now()
        self.events.append({
            "type": "crew_start",
            "timestamp": self.start_time.isoformat(),
            "agents": len(crew_info.get("agents", [])),
            "tasks": len(crew_info.get("tasks", []))
        })
        print(f"üöÄ Crew iniciado: {len(crew_info.get('agents', []))} agentes, {len(crew_info.get('tasks', []))} tareas")

    def on_task_start(self, task_info: Dict[str, Any]):
        """Callback al iniciar tarea."""
        task_id = task_info.get("task_id", "unknown")
        self.task_times[task_id] = datetime.now().timestamp()
        self.events.append({
            "type": "task_start",
            "task_id": task_id,
            "agent": task_info.get("agent", "unknown"),
            "timestamp": datetime.now().isoformat()
        })
        print(f"üìã Tarea iniciada: {task_info.get('description', '')[:50]}...")

    def on_task_complete(self, task_info: Dict[str, Any]):
        """Callback al completar tarea."""
        task_id = task_info.get("task_id", "unknown")
        duration = datetime.now().timestamp() - self.task_times.get(task_id, datetime.now().timestamp())
        self.events.append({
            "type": "task_complete",
            "task_id": task_id,
            "duration_seconds": duration,
            "output_length": len(str(task_info.get("output", ""))),
            "timestamp": datetime.now().isoformat()
        })
        print(f"‚úÖ Tarea completada en {duration:.2f}s")

    def on_crew_complete(self, result: Any):
        """Callback al completar crew."""
        total_time = (datetime.now() - self.start_time).total_seconds() if self.start_time else 0
        self.events.append({
            "type": "crew_complete",
            "total_duration_seconds": total_time,
            "result_length": len(str(result)),
            "timestamp": datetime.now().isoformat()
        })
        print(f"üéâ Crew completado en {total_time:.2f}s")

    def on_agent_action(self, agent_info: Dict[str, Any]):
        """Callback en acci√≥n de agente."""
        self.events.append({
            "type": "agent_action",
            "agent": agent_info.get("agent", "unknown"),
            "action": agent_info.get("action", "unknown"),
            "timestamp": datetime.now().isoformat()
        })

    def on_error(self, error_info: Dict[str, Any]):
        """Callback en error."""
        self.events.append({
            "type": "error",
            "error": str(error_info.get("error", "Unknown")),
            "context": error_info.get("context", {}),
            "timestamp": datetime.now().isoformat()
        })
        print(f"‚ùå Error: {error_info.get('error', 'Unknown')}")

    def get_report(self) -> Dict[str, Any]:
        """Genera reporte de ejecuci√≥n."""
        task_events = [e for e in self.events if e["type"] == "task_complete"]
        total_duration = sum(e.get("duration_seconds", 0) for e in task_events)

        return {
            "total_events": len(self.events),
            "tasks_completed": len(task_events),
            "total_task_duration": total_duration,
            "errors": len([e for e in self.events if e["type"] == "error"]),
            "events": self.events
        }

    def export_to_json(self, filepath: str):
        """Exporta eventos a JSON."""
        with open(filepath, "w") as f:
            json.dump(self.get_report(), f, indent=2)


class MonitoredCrew:
    """Wrapper de Crew con monitoreo integrado."""

    def __init__(
        self,
        agents: List[Agent],
        tasks: List[Task],
        process: Process = Process.sequential,
        monitor: CrewMonitor = None
    ):
        self.agents = agents
        self.tasks = tasks
        self.process = process
        self.monitor = monitor or CrewMonitor()
        self.crew = Crew(
            agents=agents,
            tasks=tasks,
            process=process,
            verbose=True
        )

    def kickoff(self, inputs: Dict[str, Any] = None) -> Any:
        """Ejecuta crew con monitoreo."""
        # Notificar inicio
        self.monitor.on_crew_start({
            "agents": self.agents,
            "tasks": self.tasks
        })

        try:
            # Ejecutar crew
            result = self.crew.kickoff(inputs or {})

            # Notificar completado
            self.monitor.on_crew_complete(result)

            return result

        except Exception as e:
            self.monitor.on_error({
                "error": e,
                "context": {"inputs": inputs}
            })
            raise

    def get_execution_report(self) -> Dict[str, Any]:
        """Obtiene reporte de ejecuci√≥n."""
        return self.monitor.get_report()


# Ejemplo de uso
if __name__ == "__main__":
    llm = ChatGoogleGenerativeAI(model="gemini-1.5-flash")

    # Crear agentes
    agents = [
        Agent(
            role="Investigador",
            goal="Investigar temas",
            backstory="Investigador experto",
            llm=llm
        ),
        Agent(
            role="Escritor",
            goal="Crear contenido",
            backstory="Escritor profesional",
            llm=llm
        )
    ]

    # Crear tareas
    tasks = [
        Task(
            description="Investigar sobre Python async",
            expected_output="Informe de investigaci√≥n",
            agent=agents[0]
        ),
        Task(
            description="Escribir tutorial basado en investigaci√≥n",
            expected_output="Tutorial completo",
            agent=agents[1]
        )
    ]

    # Crear crew monitoreado
    monitored_crew = MonitoredCrew(agents, tasks)

    # Ejecutar
    result = monitored_crew.kickoff()

    # Ver reporte
    report = monitored_crew.get_execution_report()
    print(f"\n=== Reporte de Ejecuci√≥n ===")
    print(json.dumps(report, indent=2, default=str))
```

## Ejercicios Pr√°cticos

### Ejercicio 1: Crew de Soporte T√©cnico
```python
"""
Ejercicio: Crear un crew de soporte t√©cnico.
"""

def build_support_crew():
    """
    TODO: Crear crew con:
    1. Agente clasificador de tickets
    2. Agente de soporte nivel 1
    3. Agente de soporte nivel 2
    4. Agente de documentaci√≥n

    Implementar:
    - Escalamiento autom√°tico de tickets
    - Registro de soluciones
    - M√©tricas de resoluci√≥n
    """
    pass
```

### Ejercicio 2: Crew de Marketing
```python
"""
Ejercicio: Crew para campa√±a de marketing.
"""

def build_marketing_crew(campaign_brief: str):
    """
    TODO: Crear crew con:
    1. Estratega de marketing
    2. Creativo de contenido
    3. Dise√±ador (descripci√≥n de dise√±os)
    4. Analista de m√©tricas

    Debe producir:
    - Estrategia de campa√±a
    - Contenido para redes sociales
    - Calendario de publicaci√≥n
    - KPIs propuestos
    """
    pass
```

## Resumen

| Componente | Descripci√≥n | Configuraci√≥n Clave |
|------------|-------------|---------------------|
| **Agent** | Entidad con rol y objetivo | role, goal, backstory, tools |
| **Task** | Unidad de trabajo | description, expected_output, agent |
| **Crew** | Equipo de agentes | agents, tasks, process |
| **Process** | Modo de ejecuci√≥n | sequential, hierarchical |
| **Tools** | Capacidades adicionales | @tool decorator o BaseTool |

---

**Siguiente:** [7.3.3 AutoGen para Conversaciones Multi-Agente](./7.3.3-autogen.md)
