# Instalación del SDK de Google Generative AI

**Tiempo estimado**: 20 minutos
**Nivel**: Básico
**Prerrequisitos**: Python 3.9+, pip, API Key configurada (0.2.1)

## ¿Por qué importa este concepto?

El SDK oficial de Google (`google-generativeai`) es la forma recomendada de interactuar con Gemini desde Python. Proporciona una interfaz limpia, manejo de errores, streaming, y soporte para todas las capacidades del modelo.

---

## Instalación

### Método 1: pip (recomendado)

```bash
# Instalación básica
pip install google-generativeai

# Con dependencias opcionales para multimodal
pip install google-generativeai[images]

# Versión específica (para reproducibilidad)
pip install google-generativeai==0.4.0
```

### Método 2: Con entorno virtual (mejor práctica)

```bash
# Crear entorno virtual
python -m venv venv

# Activar (Windows)
venv\Scripts\activate

# Activar (Linux/Mac)
source venv/bin/activate

# Instalar
pip install google-generativeai

# Guardar dependencias
pip freeze > requirements.txt
```

### Método 3: Poetry (para proyectos serios)

```bash
# Inicializar proyecto
poetry init

# Agregar dependencia
poetry add google-generativeai

# Instalar
poetry install
```

---

## Verificación de instalación

```python
#!/usr/bin/env python3
"""Verificar instalación del SDK de Gemini."""

import sys

def check_installation():
    """Verifica que el SDK esté instalado correctamente."""

    print("Verificando instalación del SDK...\n")

    # 1. Verificar versión de Python
    python_version = sys.version_info
    print(f"Python: {python_version.major}.{python_version.minor}.{python_version.micro}")

    if python_version < (3, 9):
        print("⚠️  Se recomienda Python 3.9+")

    # 2. Verificar importación del SDK
    try:
        import google.generativeai as genai
        print(f"✓ google-generativeai instalado")
    except ImportError as e:
        print(f"✗ Error importando SDK: {e}")
        print("  Ejecuta: pip install google-generativeai")
        return False

    # 3. Verificar versión del SDK
    try:
        # La versión está en el módulo
        import importlib.metadata
        version = importlib.metadata.version("google-generativeai")
        print(f"  Versión: {version}")
    except Exception:
        print("  Versión: no disponible")

    # 4. Verificar dependencias opcionales
    print("\nDependencias opcionales:")

    try:
        from PIL import Image
        print("✓ Pillow (procesamiento de imágenes)")
    except ImportError:
        print("○ Pillow no instalado (opcional para imágenes)")

    try:
        import numpy
        print("✓ NumPy")
    except ImportError:
        print("○ NumPy no instalado")

    print("\n✅ SDK instalado correctamente")
    return True


if __name__ == "__main__":
    success = check_installation()
    sys.exit(0 if success else 1)
```

---

## Configuración inicial del SDK

```python
"""
Configuración y uso básico del SDK de Gemini.
"""

import os
import google.generativeai as genai
from typing import Optional


def configure_sdk(api_key: Optional[str] = None) -> None:
    """
    Configura el SDK con la API key.

    Args:
        api_key: API key de Gemini. Si None, usa variable de entorno.

    Raises:
        ValueError: Si no se proporciona API key
    """
    key = api_key or os.environ.get("GOOGLE_API_KEY")

    if not key:
        raise ValueError(
            "API key requerida. Configura GOOGLE_API_KEY o pasa api_key="
        )

    genai.configure(api_key=key)


def list_available_models() -> list:
    """
    Lista los modelos disponibles para tu API key.

    Returns:
        Lista de nombres de modelos disponibles
    """
    models = []
    for model in genai.list_models():
        if "generateContent" in model.supported_generation_methods:
            models.append({
                "name": model.name,
                "display_name": model.display_name,
                "description": model.description,
                "input_token_limit": model.input_token_limit,
                "output_token_limit": model.output_token_limit,
            })
    return models


def get_model(
    model_name: str = "gemini-1.5-flash",
    system_instruction: Optional[str] = None,
    temperature: float = 1.0,
) -> genai.GenerativeModel:
    """
    Obtiene una instancia del modelo configurada.

    Args:
        model_name: Nombre del modelo (ej: "gemini-1.5-flash")
        system_instruction: Instrucción de sistema opcional
        temperature: Temperatura para generación (0-2)

    Returns:
        Instancia de GenerativeModel configurada
    """
    generation_config = genai.GenerationConfig(
        temperature=temperature,
        top_p=0.95,
        top_k=40,
        max_output_tokens=8192,
    )

    model = genai.GenerativeModel(
        model_name=model_name,
        generation_config=generation_config,
        system_instruction=system_instruction,
    )

    return model


# Ejemplo de uso
def demo_basic_usage():
    """Demuestra uso básico del SDK."""

    # Configurar
    configure_sdk()

    # Listar modelos disponibles
    print("Modelos disponibles:")
    for model in list_available_models():
        print(f"  - {model['name']}")
    print()

    # Crear instancia del modelo
    model = get_model(
        model_name="gemini-1.5-flash",
        system_instruction="Eres un asistente técnico conciso.",
        temperature=0.7,
    )

    # Generar contenido
    response = model.generate_content("¿Qué es una API?")
    print("Respuesta:")
    print(response.text)


if __name__ == "__main__":
    demo_basic_usage()
```

---

## Estructura del SDK

### Módulos principales

```python
import google.generativeai as genai

# Configuración global
genai.configure(api_key="...")

# Modelo generativo
model = genai.GenerativeModel("gemini-1.5-flash")

# Generación de contenido
response = model.generate_content("prompt")

# Chat (conversación)
chat = model.start_chat(history=[])
response = chat.send_message("mensaje")

# Embeddings
embed_model = genai.embed_content(
    model="models/embedding-001",
    content="texto a embebir"
)

# Conteo de tokens
tokens = model.count_tokens("texto")
```

### Clases principales

```python
from google.generativeai import GenerativeModel
from google.generativeai.types import (
    GenerationConfig,      # Configuración de generación
    SafetySettings,        # Configuración de seguridad
    HarmCategory,          # Categorías de contenido dañino
    HarmBlockThreshold,    # Umbrales de bloqueo
    ContentDict,           # Estructura de contenido
    Part,                  # Parte de contenido (texto, imagen, etc.)
)
```

---

## Manejo de errores

```python
import google.generativeai as genai
from google.api_core import exceptions


def safe_generate(model, prompt: str) -> str:
    """
    Genera contenido con manejo de errores robusto.

    Args:
        model: Instancia de GenerativeModel
        prompt: Texto del prompt

    Returns:
        Texto generado o mensaje de error
    """
    try:
        response = model.generate_content(prompt)
        return response.text

    except exceptions.InvalidArgument as e:
        # Prompt inválido o parámetros incorrectos
        return f"Error de argumento: {e}"

    except exceptions.ResourceExhausted as e:
        # Cuota excedida
        return f"Cuota excedida. Espera o aumenta límites: {e}"

    except exceptions.PermissionDenied as e:
        # API key inválida o sin permisos
        return f"Permiso denegado. Verifica tu API key: {e}"

    except exceptions.NotFound as e:
        # Modelo no encontrado
        return f"Modelo no encontrado: {e}"

    except exceptions.ServiceUnavailable as e:
        # Servicio no disponible temporalmente
        return f"Servicio no disponible. Reintenta: {e}"

    except exceptions.GoogleAPIError as e:
        # Otros errores de API
        return f"Error de API: {e}"

    except Exception as e:
        # Errores inesperados
        return f"Error inesperado: {type(e).__name__}: {e}"


# Ejemplo con reintentos
import time
from functools import wraps


def with_retry(max_retries: int = 3, delay: float = 1.0):
    """Decorador para reintentos automáticos."""

    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            last_error = None

            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except (
                    exceptions.ServiceUnavailable,
                    exceptions.ResourceExhausted,
                ) as e:
                    last_error = e
                    wait_time = delay * (2 ** attempt)  # Backoff exponencial
                    print(f"Reintento {attempt + 1}/{max_retries} en {wait_time}s...")
                    time.sleep(wait_time)

            raise last_error

        return wrapper
    return decorator


@with_retry(max_retries=3)
def generate_with_retry(model, prompt: str) -> str:
    """Genera contenido con reintentos automáticos."""
    response = model.generate_content(prompt)
    return response.text
```

---

## requirements.txt recomendado

```text
# SDK principal
google-generativeai>=0.4.0

# Procesamiento de imágenes (opcional)
Pillow>=10.0.0

# Utilidades
python-dotenv>=1.0.0  # Cargar .env
tenacity>=8.0.0       # Reintentos avanzados

# Desarrollo
pytest>=7.0.0
black>=23.0.0
mypy>=1.0.0
```

---

## Casos de prueba

```python
# test_sdk_setup.py
import os
import pytest
import google.generativeai as genai


@pytest.fixture(scope="module")
def configured_sdk():
    """Configura SDK una vez para todos los tests."""
    api_key = os.environ.get("GOOGLE_API_KEY")
    if not api_key:
        pytest.skip("GOOGLE_API_KEY no configurada")
    genai.configure(api_key=api_key)
    return True


def test_list_models(configured_sdk):
    """Verifica que podemos listar modelos."""
    models = list(genai.list_models())
    assert len(models) > 0
    print(f"✓ {len(models)} modelos disponibles")


def test_create_model(configured_sdk):
    """Verifica que podemos crear instancia de modelo."""
    model = genai.GenerativeModel("gemini-1.5-flash")
    assert model is not None
    print("✓ Modelo creado")


def test_count_tokens(configured_sdk):
    """Verifica conteo de tokens."""
    model = genai.GenerativeModel("gemini-1.5-flash")
    result = model.count_tokens("Hola mundo")
    assert result.total_tokens > 0
    print(f"✓ Tokens contados: {result.total_tokens}")


def test_generate_content(configured_sdk):
    """Verifica generación de contenido."""
    model = genai.GenerativeModel("gemini-1.5-flash")
    response = model.generate_content("Di 'test exitoso'")
    assert response.text is not None
    assert len(response.text) > 0
    print(f"✓ Contenido generado: {response.text[:50]}...")


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

---

## Resumen del concepto

**En una frase**: El SDK `google-generativeai` es la interfaz oficial de Python para Gemini, instalable con pip y configurable con tu API key.

**Comandos esenciales**:
```bash
pip install google-generativeai
export GOOGLE_API_KEY='tu-key'
python -c "import google.generativeai; print('OK')"
```

**Siguiente paso**: Módulo 0.2.3 - Primera Interacción con Gemini, donde haremos nuestra primera llamada real a la API.
