# Configuración de Google Cloud y API Keys

**Tiempo estimado**: 30 minutos
**Nivel**: Básico
**Prerrequisitos**: Cuenta de Google, navegador web

## ¿Por qué importa este concepto?

Para usar Gemini programáticamente, necesitas autenticarte con Google Cloud Platform (GCP). La API key es tu "llave" para acceder a los modelos. Una configuración correcta desde el inicio evita problemas de seguridad y te permite gestionar costos y cuotas.

## Conexión con conocimientos previos

Ya conoces qué es Gemini y sus capacidades. Ahora vamos a configurar el acceso real para que puedas llamar a la API desde tu código.

---

## Comprensión intuitiva

Piensa en GCP como un edificio de oficinas donde Google ofrece servicios de IA:
- **Proyecto GCP**: Tu oficina privada dentro del edificio
- **API Key**: La tarjeta de acceso que te permite entrar
- **Billing**: El contrato de servicios que define qué puedes usar y cuánto pagas
- **Quotas**: Límites de uso para protegerte de gastos inesperados

---

## Proceso paso a paso

### Paso 1: Crear o acceder a Google Cloud Console

1. Ve a [console.cloud.google.com](https://console.cloud.google.com)
2. Inicia sesión con tu cuenta de Google
3. Si es tu primera vez, acepta los términos de servicio

### Paso 2: Crear un nuevo proyecto

```
1. Click en el selector de proyectos (arriba a la izquierda)
2. Click en "NUEVO PROYECTO"
3. Nombre del proyecto: gemini-agents-curso
4. Organización: (dejar por defecto o seleccionar tu organización)
5. Click en "CREAR"
6. Espera ~30 segundos a que se cree
7. Selecciona el nuevo proyecto en el selector
```

### Paso 3: Habilitar la API de Gemini

```
1. Ve a "APIs y servicios" > "Biblioteca"
2. Busca "Generative Language API" o "Gemini API"
3. Click en el resultado
4. Click en "HABILITAR"
5. Espera a que se active (~10 segundos)
```

### Paso 4: Crear API Key

```
1. Ve a "APIs y servicios" > "Credenciales"
2. Click en "+ CREAR CREDENCIALES"
3. Selecciona "Clave de API"
4. ¡COPIA LA CLAVE INMEDIATAMENTE! No podrás verla de nuevo
5. Click en "Restringir clave" (recomendado)
```

### Paso 5: Restringir la API Key (Seguridad)

```
1. En la configuración de la clave:
2. Nombre: gemini-curso-dev
3. Restricciones de aplicación: (opcional, para producción)
   - Direcciones IP: Tu IP de desarrollo
   - O: Referentes HTTP para web apps
4. Restricciones de API:
   - Selecciona "Restringir clave"
   - Marca solo "Generative Language API"
5. Click en "GUARDAR"
```

### Paso 6: Configurar Billing (para uso más allá del free tier)

```
1. Ve a "Facturación"
2. Click en "VINCULAR UNA CUENTA DE FACTURACIÓN"
3. Sigue el proceso para agregar método de pago
4. Configura alertas de presupuesto:
   - Ve a "Presupuestos y alertas"
   - Crea un presupuesto de $10-50 para el curso
   - Configura alertas al 50%, 90% y 100%
```

---

## Implementación práctica

### Almacenamiento seguro de la API Key

**NUNCA** guardes la API key directamente en tu código. Usa variables de entorno:

```python
# config.py - Configuración segura de credenciales

import os
from pathlib import Path
from typing import Optional
from dataclasses import dataclass


@dataclass
class GeminiConfig:
    """Configuración para acceso a Gemini API."""
    api_key: str
    project_id: Optional[str] = None
    region: str = "us-central1"

    @classmethod
    def from_env(cls) -> "GeminiConfig":
        """
        Carga configuración desde variables de entorno.

        Variables esperadas:
        - GOOGLE_API_KEY: API key de Gemini
        - GOOGLE_CLOUD_PROJECT: (opcional) ID del proyecto
        - GOOGLE_CLOUD_REGION: (opcional) Región, default us-central1
        """
        api_key = os.environ.get("GOOGLE_API_KEY")

        if not api_key:
            raise ValueError(
                "GOOGLE_API_KEY no está configurada. "
                "Ejecuta: export GOOGLE_API_KEY='tu-api-key'"
            )

        return cls(
            api_key=api_key,
            project_id=os.environ.get("GOOGLE_CLOUD_PROJECT"),
            region=os.environ.get("GOOGLE_CLOUD_REGION", "us-central1"),
        )

    @classmethod
    def from_dotenv(cls, path: str = ".env") -> "GeminiConfig":
        """
        Carga configuración desde archivo .env

        Formato del archivo:
        GOOGLE_API_KEY=AIza...
        GOOGLE_CLOUD_PROJECT=mi-proyecto
        """
        env_path = Path(path)

        if not env_path.exists():
            raise FileNotFoundError(
                f"Archivo {path} no encontrado. "
                "Crea uno basándote en .env.example"
            )

        # Parsear archivo .env manualmente (sin dependencias)
        env_vars = {}
        with open(env_path) as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith("#") and "=" in line:
                    key, value = line.split("=", 1)
                    env_vars[key.strip()] = value.strip().strip('"\'')

        api_key = env_vars.get("GOOGLE_API_KEY")
        if not api_key:
            raise ValueError("GOOGLE_API_KEY no encontrada en .env")

        return cls(
            api_key=api_key,
            project_id=env_vars.get("GOOGLE_CLOUD_PROJECT"),
            region=env_vars.get("GOOGLE_CLOUD_REGION", "us-central1"),
        )


def validate_api_key(api_key: str) -> bool:
    """
    Valida formato básico de la API key.

    Las API keys de Google típicamente:
    - Empiezan con 'AIza'
    - Tienen ~39 caracteres
    """
    if not api_key:
        return False

    if not api_key.startswith("AIza"):
        print("Advertencia: API key no empieza con 'AIza'")
        return False

    if len(api_key) < 30:
        print("Advertencia: API key parece muy corta")
        return False

    return True


# Ejemplo de archivo .env.example (crear en la raíz del proyecto)
ENV_EXAMPLE = """
# ===========================================
# Configuración de Google Cloud / Gemini API
# ===========================================

# API Key de Gemini (REQUERIDA)
# Obtener en: https://console.cloud.google.com/apis/credentials
GOOGLE_API_KEY=tu-api-key-aqui

# ID del proyecto de GCP (opcional)
GOOGLE_CLOUD_PROJECT=tu-proyecto-id

# Región (opcional, default: us-central1)
GOOGLE_CLOUD_REGION=us-central1
"""


def create_env_example():
    """Crea archivo .env.example si no existe."""
    example_path = Path(".env.example")
    if not example_path.exists():
        with open(example_path, "w") as f:
            f.write(ENV_EXAMPLE.strip())
        print(f"Creado: {example_path}")


# Verificación de configuración
def check_setup() -> bool:
    """
    Verifica que la configuración esté correcta.

    Returns:
        True si todo está configurado correctamente
    """
    print("Verificando configuración de Gemini...\n")

    # 1. Verificar variable de entorno
    api_key = os.environ.get("GOOGLE_API_KEY")
    if api_key:
        print("✓ GOOGLE_API_KEY está configurada")
        if validate_api_key(api_key):
            print("✓ Formato de API key válido")
        else:
            print("✗ Formato de API key inválido")
            return False
    else:
        # 2. Verificar archivo .env
        if Path(".env").exists():
            print("✓ Archivo .env encontrado")
            try:
                config = GeminiConfig.from_dotenv()
                print("✓ API key cargada desde .env")
            except Exception as e:
                print(f"✗ Error cargando .env: {e}")
                return False
        else:
            print("✗ No se encontró GOOGLE_API_KEY ni archivo .env")
            print("\nPara configurar:")
            print("  1. export GOOGLE_API_KEY='tu-api-key'")
            print("  2. O crea un archivo .env con GOOGLE_API_KEY=tu-api-key")
            return False

    print("\n✅ Configuración válida")
    return True
```

### Estructura de proyecto recomendada

```
mi-proyecto-gemini/
├── .env                 # Variables de entorno (NO commitear)
├── .env.example         # Plantilla sin secretos (SÍ commitear)
├── .gitignore           # Incluir .env
├── config.py            # Lógica de configuración
├── main.py              # Código principal
└── requirements.txt     # Dependencias
```

### Archivo .gitignore

```gitignore
# Secretos y credenciales
.env
*.json  # Service account keys
secrets/

# Python
__pycache__/
*.pyc
.venv/
venv/

# IDE
.vscode/
.idea/
```

### Script de verificación

```python
#!/usr/bin/env python3
"""
Script para verificar la configuración de Gemini API.
Ejecutar: python verify_setup.py
"""

import os
import sys


def main():
    print("=" * 50)
    print("Verificación de configuración de Gemini API")
    print("=" * 50)
    print()

    # Verificar Python
    print(f"Python: {sys.version}")
    print()

    # Verificar API key
    api_key = os.environ.get("GOOGLE_API_KEY")

    if not api_key:
        # Intentar cargar de .env
        if os.path.exists(".env"):
            with open(".env") as f:
                for line in f:
                    if line.startswith("GOOGLE_API_KEY="):
                        api_key = line.split("=", 1)[1].strip().strip('"\'')
                        break

    if api_key:
        # Mostrar parcialmente por seguridad
        masked = api_key[:8] + "..." + api_key[-4:]
        print(f"✓ API Key encontrada: {masked}")
    else:
        print("✗ API Key NO encontrada")
        print()
        print("Para configurar:")
        print("  export GOOGLE_API_KEY='tu-api-key'")
        print("  # O crea archivo .env con GOOGLE_API_KEY=tu-api-key")
        sys.exit(1)

    # Verificar SDK instalado
    try:
        import google.generativeai as genai
        print(f"✓ SDK instalado: google-generativeai")
    except ImportError:
        print("✗ SDK no instalado")
        print("  pip install google-generativeai")
        sys.exit(1)

    # Test de conexión
    print()
    print("Probando conexión a la API...")
    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel("gemini-1.5-flash")
        response = model.generate_content("Di 'Hola' en una palabra")
        print(f"✓ Conexión exitosa!")
        print(f"  Respuesta: {response.text.strip()}")
    except Exception as e:
        print(f"✗ Error de conexión: {e}")
        sys.exit(1)

    print()
    print("=" * 50)
    print("✅ ¡Todo configurado correctamente!")
    print("=" * 50)


if __name__ == "__main__":
    main()
```

---

## Casos de prueba

```python
# test_config.py
import os
import tempfile
from pathlib import Path

# Test 1: Cargar desde variable de entorno
print("Test 1: Cargar desde variable de entorno")
os.environ["GOOGLE_API_KEY"] = "AIzaTestKey123456789012345678901234"
config = GeminiConfig.from_env()
assert config.api_key == "AIzaTestKey123456789012345678901234"
print("✓ Carga desde env exitosa")

# Test 2: Cargar desde .env
print("\nTest 2: Cargar desde archivo .env")
with tempfile.NamedTemporaryFile(mode='w', suffix='.env', delete=False) as f:
    f.write('GOOGLE_API_KEY="AIzaFromDotEnv123456789012345678"')
    temp_path = f.name

config = GeminiConfig.from_dotenv(temp_path)
assert "AIzaFromDotEnv" in config.api_key
os.unlink(temp_path)
print("✓ Carga desde .env exitosa")

# Test 3: Validación de formato
print("\nTest 3: Validación de formato de API key")
assert validate_api_key("AIzaValidKeyFormat12345678901234567") == True
assert validate_api_key("invalid") == False
assert validate_api_key("") == False
print("✓ Validación funcionando")

# Test 4: Error cuando no hay API key
print("\nTest 4: Error sin API key")
del os.environ["GOOGLE_API_KEY"]
try:
    GeminiConfig.from_env()
    assert False, "Debería haber lanzado error"
except ValueError as e:
    assert "GOOGLE_API_KEY" in str(e)
    print("✓ Error apropiado lanzado")

print("\n✅ Todos los tests pasaron")
```

---

## Errores frecuentes

### Error 1: API key en el código

```python
# ❌ NUNCA HAGAS ESTO
api_key = "AIzaSyD..."  # ¡Expuesta en git!
```

**Por qué falla**: Si commiteas esto, cualquiera con acceso al repo puede usar tu API key y generar cargos.

### Solución correcta

```python
# ✓ Usar variables de entorno
import os
api_key = os.environ.get("GOOGLE_API_KEY")
```

### Error 2: Commitear archivo .env

```bash
# ❌ Si .env está en el repo
git add .env
git commit -m "Agregar configuración"  # ¡Secretos expuestos!
```

**Solución**: Agregar `.env` a `.gitignore` ANTES del primer commit.

### Error 3: No configurar billing y quedarse sin cuota

```python
# Error típico cuando excedes free tier sin billing:
# google.api_core.exceptions.ResourceExhausted:
# 429 Resource has been exhausted
```

**Solución**: Configurar billing con alertas de presupuesto.

---

## Seguridad y mejores prácticas

### Rotación de API keys

Si sospechas que tu key fue comprometida:
1. Ve a "APIs y servicios" > "Credenciales"
2. Click en la key comprometida
3. Click en "REGENERAR CLAVE"
4. Actualiza la nueva key en todos tus sistemas
5. La key antigua dejará de funcionar inmediatamente

### Uso de múltiples keys

```python
# Para separar desarrollo, staging y producción
ENVIRONMENTS = {
    "development": os.environ.get("GEMINI_API_KEY_DEV"),
    "staging": os.environ.get("GEMINI_API_KEY_STAGING"),
    "production": os.environ.get("GEMINI_API_KEY_PROD"),
}

def get_api_key(env: str = "development") -> str:
    return ENVIRONMENTS.get(env)
```

### Monitoreo de uso

1. Ve a "APIs y servicios" > "Panel"
2. Selecciona "Generative Language API"
3. Revisa gráficos de:
   - Tráfico (requests por segundo)
   - Errores (4xx, 5xx)
   - Latencia

---

## Resumen del concepto

**En una frase**: La API key es tu credencial para acceder a Gemini; guárdala de forma segura en variables de entorno, nunca en el código.

**Checklist de configuración**:
1. ✅ Crear proyecto en GCP
2. ✅ Habilitar Generative Language API
3. ✅ Crear y restringir API key
4. ✅ Guardar en .env (no en código)
5. ✅ Agregar .env a .gitignore
6. ✅ Configurar billing con alertas

**Siguiente paso**: Módulo 0.2.2 - Instalación del SDK de Google Generative AI.
