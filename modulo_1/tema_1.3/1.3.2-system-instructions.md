# System Instructions

**Tiempo estimado**: 35 minutos
**Nivel**: Intermedio
**Prerrequisitos**: Chat sessions (1.3.1)

## ¿Por qué importa este concepto?

Las System Instructions definen la "personalidad" y comportamiento base del modelo. Son el equivalente a darle instrucciones a un empleado antes de que empiece a trabajar:
- Qué rol debe asumir
- Cómo debe responder
- Qué restricciones tiene
- Qué formato usar

A diferencia de los prompts de usuario, las System Instructions:
- Se aplican a **todas** las respuestas
- No cambian durante la conversación
- Tienen mayor "peso" que instrucciones del usuario

---

## Configuración básica

```python
import google.generativeai as genai
import os

genai.configure(api_key=os.environ["GOOGLE_API_KEY"])


# System instruction como string
model = genai.GenerativeModel(
    model_name="gemini-1.5-flash",
    system_instruction="Eres un asistente de programación experto en Python. Responde siempre en español."
)

response = model.generate_content("¿Cómo creo una lista?")
print(response.text)
```

### System instruction detallada

```python
system_prompt = """
# ROL
Eres CodeHelper, un asistente especializado en programación Python.

# ESTILO
- Responde de forma clara y concisa
- Usa ejemplos de código cuando sea útil
- Explica los conceptos paso a paso
- Evita jerga innecesaria

# FORMATO
- Usa markdown para formato
- Código en bloques con syntax highlighting
- Listas para múltiples puntos

# RESTRICCIONES
- Solo responde preguntas sobre programación
- Si la pregunta no es sobre código, indica amablemente que solo ayudas con programación
- No generes código malicioso o inseguro
- Si no sabes algo, admítelo

# IDIOMA
Responde siempre en español, incluso si te escriben en otro idioma.
"""

model = genai.GenerativeModel(
    "gemini-1.5-flash",
    system_instruction=system_prompt
)
```

---

## Patrones de System Instructions

### 1. Asistente especializado

```python
EXPERT_ASSISTANT = """
Eres un experto en {DOMINIO} con más de 20 años de experiencia.

Características:
- Profundo conocimiento técnico en {DOMINIO}
- Capacidad de explicar conceptos complejos de forma simple
- Orientado a soluciones prácticas

Cuando respondas:
1. Primero confirma que entiendes la pregunta
2. Proporciona la respuesta directa
3. Explica el razonamiento si es necesario
4. Ofrece alternativas cuando sea relevante
"""

def create_expert_assistant(domain: str):
    """Crea un asistente experto en un dominio."""
    instruction = EXPERT_ASSISTANT.replace("{DOMINIO}", domain)
    return genai.GenerativeModel(
        "gemini-1.5-flash",
        system_instruction=instruction
    )


# Crear expertos en diferentes áreas
python_expert = create_expert_assistant("Python y desarrollo de software")
ml_expert = create_expert_assistant("Machine Learning y Data Science")
security_expert = create_expert_assistant("Ciberseguridad")
```

### 2. Formateador de respuestas

```python
JSON_RESPONDER = """
IMPORTANTE: SIEMPRE responde en formato JSON válido.

Estructura de respuesta:
{
    "answer": "tu respuesta aquí",
    "confidence": 0.0-1.0,
    "sources": ["fuentes si las hay"],
    "follow_up_questions": ["preguntas sugeridas"]
}

Reglas:
- El JSON debe ser parseable
- No incluyas texto fuera del JSON
- Si no puedes responder, usa {"error": "razón", "answer": null}
"""

json_model = genai.GenerativeModel(
    "gemini-1.5-flash",
    system_instruction=JSON_RESPONDER
)

response = json_model.generate_content("¿Qué es Python?")
import json
data = json.loads(response.text)
print(f"Respuesta: {data['answer']}")
print(f"Confianza: {data['confidence']}")
```

### 3. Moderador de contenido

```python
CONTENT_MODERATOR = """
Eres un moderador de contenido. Tu trabajo es analizar texto y determinar si es apropiado.

Para cada mensaje:
1. Analiza el contenido
2. Identifica cualquier problema potencial
3. Clasifica según estas categorías:
   - SAFE: Contenido apropiado
   - WARNING: Contenido que requiere revisión
   - BLOCK: Contenido inapropiado

Responde en JSON:
{
    "classification": "SAFE|WARNING|BLOCK",
    "reason": "explicación breve",
    "categories": ["lista de categorías relevantes"]
}

Categorías posibles: spam, hate_speech, violence, adult_content, misinformation, harassment, safe

Sé estricto pero justo. No bloquees contenido legítimo.
"""

moderator = genai.GenerativeModel(
    "gemini-1.5-flash",
    system_instruction=CONTENT_MODERATOR
)
```

### 4. Agente con herramientas

```python
AGENT_INSTRUCTION = """
Eres un agente de investigación con acceso a herramientas.

Herramientas disponibles:
- web_search(query): Busca información en internet
- calculate(expression): Realiza cálculos matemáticos
- get_current_time(): Obtiene la hora actual

Proceso de trabajo:
1. Analiza la solicitud del usuario
2. Determina qué herramientas necesitas
3. Usa las herramientas en el orden correcto
4. Sintetiza la información
5. Proporciona una respuesta clara

Formato para llamar herramientas:
<tool>nombre_herramienta(argumentos)</tool>

Siempre explica tu razonamiento antes de usar una herramienta.
"""
```

---

## Combinación con GenerationConfig

```python
from google.generativeai import GenerationConfig


def create_configured_assistant(
    system_instruction: str,
    temperature: float = 0.7,
    max_tokens: int = 2048
) -> genai.GenerativeModel:
    """
    Crea asistente con system instruction y config.
    """
    config = GenerationConfig(
        temperature=temperature,
        max_output_tokens=max_tokens,
        top_p=0.95,
    )

    return genai.GenerativeModel(
        "gemini-1.5-flash",
        system_instruction=system_instruction,
        generation_config=config
    )


# Asistente creativo
creative_assistant = create_configured_assistant(
    system_instruction="Eres un escritor creativo. Usa metáforas y lenguaje evocador.",
    temperature=1.2,
    max_tokens=4096
)

# Asistente técnico
technical_assistant = create_configured_assistant(
    system_instruction="Eres un ingeniero de software. Sé preciso y técnico.",
    temperature=0.3,
    max_tokens=2048
)
```

---

## System Instructions en Chat

```python
CUSTOMER_SERVICE = """
Eres un agente de servicio al cliente de TechCorp.

Información de la empresa:
- Horario: Lunes a Viernes 9am-6pm
- Email: soporte@techcorp.com
- Productos: Software de gestión empresarial

Políticas:
- Devoluciones: 30 días
- Soporte técnico: Incluido con licencia activa
- Actualizaciones: Gratuitas por 1 año

Comportamiento:
- Sé amable y profesional
- Confirma la información del cliente antes de hacer cambios
- Ofrece alternativas cuando no puedas resolver algo
- Escala a un humano si el problema es complejo
"""

def start_customer_service_chat():
    """Inicia chat de servicio al cliente."""
    model = genai.GenerativeModel(
        "gemini-1.5-flash",
        system_instruction=CUSTOMER_SERVICE
    )
    return model.start_chat()


# Uso
chat = start_customer_service_chat()
print(chat.send_message("Hola, tengo un problema con mi licencia").text)
print(chat.send_message("No puedo activar el software").text)
```

---

## Validación de System Instructions

```python
def validate_system_instruction(instruction: str) -> dict:
    """
    Valida una system instruction.

    Checks:
    - Longitud apropiada
    - Secciones recomendadas
    - Claridad
    """
    issues = []
    suggestions = []

    # Check longitud
    if len(instruction) < 50:
        issues.append("Muy corta - considera agregar más contexto")
    elif len(instruction) > 5000:
        suggestions.append("Considera resumir - instrucciones muy largas pueden ser ignoradas parcialmente")

    # Check secciones comunes
    recommended_sections = {
        "rol": ["rol", "eres", "actúa como", "tu función"],
        "formato": ["formato", "responde en", "estructura"],
        "restricciones": ["no", "evita", "nunca", "restricciones"],
    }

    instruction_lower = instruction.lower()
    for section, keywords in recommended_sections.items():
        if not any(kw in instruction_lower for kw in keywords):
            suggestions.append(f"Considera agregar sección de {section}")

    # Check claridad
    if instruction.count('\n') < 3 and len(instruction) > 200:
        suggestions.append("Usa saltos de línea para mejorar legibilidad")

    return {
        "valid": len(issues) == 0,
        "issues": issues,
        "suggestions": suggestions,
        "char_count": len(instruction),
        "estimated_tokens": len(instruction) // 4  # Aproximación
    }


# Validar
result = validate_system_instruction(CUSTOMER_SERVICE)
print(f"Válido: {result['valid']}")
print(f"Tokens estimados: {result['estimated_tokens']}")
for s in result['suggestions']:
    print(f"  - {s}")
```

---

## Casos de prueba

```python
# test_system_instructions.py
import pytest
import google.generativeai as genai
import os


@pytest.fixture
def configured():
    genai.configure(api_key=os.environ["GOOGLE_API_KEY"])
    return True


def test_system_instruction_applied(configured):
    """Test que system instruction se aplica."""
    model = genai.GenerativeModel(
        "gemini-1.5-flash",
        system_instruction="Siempre responde con exactamente 3 palabras."
    )

    response = model.generate_content("¿Cómo estás?")
    words = response.text.strip().split()

    # Debería ser aproximadamente 3 palabras
    assert 1 <= len(words) <= 5, f"Esperaba ~3 palabras, obtuvo {len(words)}"
    print(f"✓ Respuesta: '{response.text}' ({len(words)} palabras)")


def test_language_instruction(configured):
    """Test que responde en el idioma indicado."""
    model = genai.GenerativeModel(
        "gemini-1.5-flash",
        system_instruction="SIEMPRE responde en español, sin importar el idioma de la pregunta."
    )

    response = model.generate_content("What is Python?")

    # Debería contener palabras en español
    spanish_words = ["es", "un", "el", "la", "de", "para", "que"]
    has_spanish = any(word in response.text.lower() for word in spanish_words)

    assert has_spanish, f"No parece español: {response.text[:100]}"
    print("✓ Responde en español")


def test_format_instruction(configured):
    """Test que respeta formato indicado."""
    model = genai.GenerativeModel(
        "gemini-1.5-flash",
        system_instruction='Responde SOLO en JSON con formato: {"respuesta": "texto"}'
    )

    response = model.generate_content("¿Cuánto es 2+2?")

    import json
    try:
        text = response.text.strip()
        if text.startswith("```"):
            text = text.split("```")[1].replace("json", "").strip()
        data = json.loads(text)
        assert "respuesta" in data
        print(f"✓ JSON válido: {data}")
    except json.JSONDecodeError:
        pytest.fail(f"No es JSON válido: {response.text}")


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

---

## Resumen del concepto

**En una frase**: System Instructions definen el comportamiento base del modelo - su rol, estilo, formato y restricciones que se aplican a todas las respuestas.

**Mejores prácticas**:
1. Ser específico sobre el rol
2. Definir formato de respuesta esperado
3. Incluir restricciones claras
4. Usar ejemplos cuando sea útil

**Patrón básico**:
```python
model = genai.GenerativeModel(
    "gemini-1.5-flash",
    system_instruction="Tu instrucción aquí"
)
```

**Módulo 1 Completado** - Siguiente: Módulo 2 - Ingeniería de Prompts Avanzada.
